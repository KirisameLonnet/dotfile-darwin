# Nix-darwin

æœ¬ä»“åº“åŒ…å«ä¸€å¥—å®Œæ•´çš„ã€æ¨¡å—åŒ–çš„ macOS é…ç½®ï¼ŒåŸºäº [Nix](https://nixos.org/)ã€[nix-darwin](https://github.com/LnL7/nix-darwin) å’Œ [home-manager](https://github.com/nix-community/home-manager) æ„å»ºã€‚å®ƒæ—¨åœ¨æä¾›ä¸€ä¸ªä¸€è‡´ã€å¯å¤ç°ä¸”é«˜åº¦è‡ªåŠ¨åŒ–çš„å¼€å‘ç¯å¢ƒï¼Œæ ¸å¿ƒæ˜¯å›´ç»• [yabai](https://github.com/koekeishiya/yabai) å’Œ [skhd](https://github.com/koekeishiya/skhd) æ‰“é€ çš„å¹³é“ºå¼çª—å£ç®¡ç†å™¨ä½“éªŒã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **å£°æ˜å¼é…ç½®**: é€šè¿‡ Nix åŒæ—¶ç®¡ç†ç³»ç»Ÿçº§ (`nix-darwin`) å’Œç”¨æˆ·çº§ (`home-manager`) çš„é…ç½®ã€‚
- **å¯å¤ç°ç¯å¢ƒ**: ä¸€é”®åœ¨æ–°è®¾å¤‡ä¸Šå¤ç°ä½ ç†Ÿæ‚‰çš„å¼€å‘ç¯å¢ƒã€‚
- **å¹³é“ºå¼çª—å£ç®¡ç†å™¨**: é¢„è®¾ `yabai` å’Œ `skhd`ï¼Œæä¾›é«˜æ•ˆã€é”®ç›˜é©±åŠ¨çš„å·¥ä½œæµã€‚
- **æ¨¡å—åŒ–ä¸è‡ªåŠ¨åŒ–**: é…ç½®ç»“æ„æ¸…æ™°ï¼Œå¹¶é€šè¿‡ `Makefile` ç®€åŒ–äº†æ‰€æœ‰å¸¸ç”¨æ“ä½œã€‚

## ğŸš€ å¿«é€Ÿä¸Šæ‰‹

1.  **ç¯å¢ƒå‡†å¤‡**:
    *   å®‰è£… [Nix åŒ…ç®¡ç†å™¨](https://nixos.org/download.html) å¹¶å¯ç”¨ Flakesã€‚
    *   å®‰è£… Xcode å‘½ä»¤è¡Œå·¥å…·: `xcode-select --install`

2.  **å…‹éš†ä»“åº“**:
    ```bash
    # æ¨èå°†é…ç½®å…‹éš†åˆ° ~/.config/nixconfig
    git clone https://github.com/your-username/nixconfig.git ~/.config/nixconfig
    cd ~/.config/nixconfig
    ```

3.  **åº”ç”¨é…ç½®**:
    ```bash
    # æ„å»ºé…ç½®å¹¶åˆ‡æ¢åˆ°æ–°ç³»ç»Ÿ
    make switch
    ```
    æ­¤å‘½ä»¤å°†æ„å»º `flake.nix` ä¸­å®šä¹‰çš„å®Œæ•´ç³»ç»Ÿé…ç½®ï¼Œå¹¶æ¿€æ´»å®ƒã€‚

4.  **æˆæƒè¾…åŠ©åŠŸèƒ½**:
    é¦–æ¬¡å®‰è£…åï¼Œçª—å£ç®¡ç†å™¨éœ€è¦æƒé™æ‰èƒ½å·¥ä½œã€‚
    ```bash
    make permissions
    ```
    æ­¤å‘½ä»¤ä¼šæ‰“å¼€ç³»ç»Ÿè®¾ç½®é¢æ¿ï¼Œè¯·æ‰‹åŠ¨ä¸º `yabai` æˆæƒã€‚

## âš™ï¸ Makefile ä½¿ç”¨æŒ‡å—

`Makefile` æ˜¯ç®¡ç†æœ¬é…ç½®çš„ä¸»è¦å…¥å£ï¼Œå°è£…äº†æ‰€æœ‰å¸¸ç”¨å‘½ä»¤ã€‚

<details>
<summary>ç‚¹å‡»å±•å¼€/æŠ˜å  Makefile å‘½ä»¤åˆ—è¡¨</summary>

| å‘½ä»¤ | æè¿° |        
| :--- | :--- |
| **æ ¸å¿ƒå‘½ä»¤** | |
| `make switch` | **(æœ€å¸¸ç”¨)** æ„å»ºå¹¶åº”ç”¨æ–°é…ç½®ã€‚å¯¹é…ç½®çš„ä»»ä½•æ›´æ”¹éƒ½é€šè¿‡æ­¤å‘½ä»¤ç”Ÿæ•ˆã€‚ |
| `make build` | ä»…æ„å»ºé…ç½®ï¼Œä¸æ¿€æ´»ã€‚ç”¨äºåœ¨åº”ç”¨å‰æ£€æŸ¥é…ç½®æ˜¯å¦å­˜åœ¨é”™è¯¯ã€‚ |
| `make update` | æ›´æ–°æ‰€æœ‰ Nix Flake ä¾èµ– (å¦‚ nixpkgs) åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶åº”ç”¨æ–°é…ç½®ã€‚ |
| **æœåŠ¡ç®¡ç†** | |
| `make restart-all` | é‡å¯æ‰€æœ‰çª—å£ç®¡ç†å™¨ç›¸å…³çš„æœåŠ¡ (`yabai`, `skhd`)ã€‚ |
| `make restart-yabai` | åªé‡å¯ `yabai` æœåŠ¡ã€‚ |
| `make restart-skhd` | åªé‡å¯ `skhd` æœåŠ¡ã€‚ |
| **è¯Šæ–­ä¸ç»´æŠ¤** | |
| `make status` | æ˜¾ç¤ºè¯¦ç»†çš„ç³»ç»ŸçŠ¶æ€ï¼ŒåŒ…æ‹¬æœåŠ¡è¿è¡ŒçŠ¶æ€å’Œé…ç½®æ–‡ä»¶æ£€æŸ¥ã€‚ |
| `make logs` | æ˜¾ç¤º `yabai` å’Œ `skhd` çš„æœ€æ–°æ—¥å¿—ï¼Œç”¨äºæ’æŸ¥é—®é¢˜ã€‚ |
| `make test` | è¿è¡Œä¸€ç³»åˆ—æµ‹è¯•ï¼Œæ£€æŸ¥ `yabai` æƒé™ã€`skhd` è¯­æ³•ç­‰ã€‚ |
| `make clean` | æ¸…ç†æ—§çš„ Nix Store generations å’Œæ„å»ºäº§ç‰©ï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´ã€‚ |
| `make format` | æ ¼å¼åŒ–é¡¹ç›®ä¸­çš„æ‰€æœ‰ `.nix` æ–‡ä»¶ã€‚ |
| `make help` | æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„ `make` å‘½ä»¤åŠå…¶æè¿°ã€‚ |

</details>

## ğŸ› ï¸ å·²å®‰è£…å·¥å…·ä¸åˆ«å

æœ¬é…ç½®é€šè¿‡ Nix å’Œ Homebrew å®‰è£…äº†å¤§é‡å·¥å…·ï¼Œå¹¶é€šè¿‡ Zsh æä¾›äº†æ–¹ä¾¿çš„åˆ«åã€‚

<details>
<summary>ç‚¹å‡»å±•å¼€/æŠ˜å å·¥å…·ä¸åˆ«ååˆ—è¡¨</summary>

### ä¸»è¦å·¥å…·

| ç±»åˆ« | å·¥å…· | æè¿° |
| :--- | :--- | :--- |
| **ç»ˆç«¯ä¸ Shell** | `alacritty`, `zsh`, `starship` | ç»ˆç«¯ã€Shell åŠæç¤ºç¬¦ |
| | `tmux`, `zellij` | ç»ˆç«¯å¤ç”¨å™¨ |
| | `eza`, `bat`, `ripgrep`, `fd` | `ls`, `cat`, `grep`, `find` çš„ç°ä»£æ›¿ä»£å“ |
| **å¼€å‘å·¥å…·** | `neovim` | é«˜åº¦å¯æ‰©å±•çš„æ–‡æœ¬ç¼–è¾‘å™¨ |
| | `git`, `gh`, `lazygit`, `delta` | ç‰ˆæœ¬æ§åˆ¶ä¸è¾…åŠ©å·¥å…· |
| | `nodejs`, `python3`, `rustc`, `go` | å¤šè¯­è¨€å¼€å‘ç¯å¢ƒ |
| **ç³»ç»Ÿä¸ç›‘æ§** | `htop`, `btop` | è¿›ç¨‹ä¸ç³»ç»Ÿç›‘æ§ |
| | `fastfetch` | ç³»ç»Ÿä¿¡æ¯å±•ç¤ºå·¥å…· |

### å¸¸ç”¨åˆ«å

| åˆ«å | åŸå§‹å‘½ä»¤ | æè¿° |
| :--- | :--- | :--- |
| `ll`, `ls` | `eza -la`, `eza` | ç°ä»£åŒ–çš„ `ls` |
| `cat` | `bat` | è¯­æ³•é«˜äº®çš„ `cat` |
| `vim`, `v` | `nvim` | ä½¿ç”¨ Neovim |
| `..` | `cd ..` | å¿«é€Ÿåˆ‡æ¢ä¸Šçº§ç›®å½• |
| `g`, `gs`, `ga` | `git`, `git status`, `git add` | Git å¸¸ç”¨å‘½ä»¤ |
| `nixup` | `darwin-rebuild switch --flake ...` | æ›´æ–°å¹¶åº”ç”¨ Nix é…ç½® |
| `reload` | `source ~/.zshrc` | é‡æ–°åŠ è½½ Zsh é…ç½® |

</details>

## âŒ¨ï¸ Yabai + Skhd å¿«æ·é”®

æ‰€æœ‰å¿«æ·é”®é…ç½®åœ¨ `config/skhd/skhdrc` æ–‡ä»¶ä¸­ã€‚ä¸»è¦ä¿®é¥°é”®ä¸º `Alt`ã€‚

<details>
<summary>ç‚¹å‡»å±•å¼€/æŠ˜å å¿«æ·é”®åˆ—è¡¨</summary>

### çª—å£ç®¡ç†
- `Alt + H/J/K/L`: ç„¦ç‚¹åˆ‡æ¢ (å·¦/ä¸‹/ä¸Š/å³)
- `Shift + Alt + H/J/K/L`: ç§»åŠ¨çª—å£
- `Ctrl + Alt + H/J/K/L`: è°ƒæ•´çª—å£å¤§å°
- `Shift + Alt + Space`: åˆ‡æ¢çª—å£æµ®åŠ¨/å¹³é“ºæ¨¡å¼
- `Alt + F`: åˆ‡æ¢çª—å£ç¼©æ”¾å…¨å±
- `Alt + Q`: å…³é—­å½“å‰çª—å£

### å·¥ä½œåŒº (Space) ç®¡ç†
- `Alt + 1...0`: åˆ‡æ¢åˆ°æŒ‡å®šå·¥ä½œåŒº
- `Shift + Alt + 1...0`: ç§»åŠ¨å½“å‰çª—å£åˆ°æŒ‡å®šå·¥ä½œåŒº
- `Shift + Alt + D`: åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œåŒºå¹¶åˆ‡æ¢

### å¸ƒå±€ç®¡ç†
- `Ctrl + Alt + A/D/S`: åˆ‡æ¢ä¸º BSP/æµ®åŠ¨/å †å å¸ƒå±€
- `Alt + E`: åˆ‡æ¢çª—å£åˆ†å‰²æ–¹å‘ (æ°´å¹³/å‚ç›´)

### åº”ç”¨ä¸ç³»ç»Ÿ
- `Alt + Return`: æ‰“å¼€ Alacritty ç»ˆç«¯
- `Shift + Ctrl + Alt + R`: é‡å¯ Yabai æœåŠ¡

</details>

## ğŸ“ Neovim é…ç½®

é›†æˆäº†åŠŸèƒ½é½å…¨çš„ Neovim ç¯å¢ƒï¼Œé…ç½®äº `modules/home-manager/editor/nvim.nix`ã€‚

### æ’ä»¶ä½¿ç”¨æŒ‡å—

**Leader é”®**: `Space` (ç©ºæ ¼é”®)

| å¿«æ·é”® | åŠŸèƒ½ | æ’ä»¶ |
| :--- | :--- | :--- |
| `<Space> + e` | æ‰“å¼€æˆ–å…³é—­æ–‡ä»¶æµè§ˆå™¨ | `neo-tree.nvim` |
| `<Space> + ff` | **F**ind **F**iles - æ¨¡ç³Šæœç´¢é¡¹ç›®ä¸­çš„æ–‡ä»¶ | `telescope.nvim` |
| `<Space> + fg` | **F**ind **G**rep - åœ¨é¡¹ç›®ä¸­è¿›è¡Œæ–‡æœ¬æœç´¢ | `telescope.nvim` |
| `gd` | **G**o to **D**efinition - è·³è½¬åˆ°å®šä¹‰ | `nvim-lspconfig` |
| `K` | (æ™®é€šæ¨¡å¼ä¸‹) æ˜¾ç¤ºå…‰æ ‡ä¸‹ç¬¦å·çš„æ–‡æ¡£ | `lspsaga.nvim` |
| `<Space> + ca` | **C**ode **A**ction - æ˜¾ç¤ºå¯ç”¨çš„ä»£ç æ“ä½œ | `lspsaga.nvim` |
| `<Space> + gb` | **G**it **B**lame - æ˜¾ç¤ºå½“å‰è¡Œçš„ Git Blame ä¿¡æ¯ | `gitsigns.nvim` |
| `<Tab>` | (æ’å…¥æ¨¡å¼ä¸‹) æ¥å— GitHub Copilot çš„å»ºè®® | `copilot.lua` |
| `<Space> + h` | æ˜¾ç¤º Neovim å¿«æ·é”®å¸®åŠ©èœå• | (è‡ªå®šä¹‰) |

## ğŸ”§ è‡ªå®šä¹‰ä¸ç»´æŠ¤

- **æ·»åŠ è½¯ä»¶åŒ…**: ç¼–è¾‘ `modules/home-manager/packages/` æˆ– `modules/darwin/homebrew.nix`ï¼Œç„¶åè¿è¡Œ `make switch`ã€‚
- **ä¿®æ”¹å¿«æ·é”®**: ç¼–è¾‘ `config/skhd/skhdrc`ï¼Œç„¶åè¿è¡Œ `make restart-skhd` æˆ– `make switch`ã€‚
- **ä¿®æ”¹ Neovim**: ç¼–è¾‘ `modules/home-manager/editor/nvim.nix`ï¼Œç„¶åè¿è¡Œ `make switch`.


